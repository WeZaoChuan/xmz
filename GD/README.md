# GD32F470 ??????????????

## ??????

???????????????????????????GD32F470VET6???????????????????GD32????????????????????????????????????????????????????????????????GD32?????????????????

## ?????
- ???????: GD32F470VET6 (ARM Cortex-M4, ??????200MHz)
- ??????: CMIC_GD32F470VET6 (???????????????????)
- ????????:
  - LED (6?????LED)
  - ???? (6?????????+1????????)
  - OLED????? (0.91???, SSD1306, I2C???)
  - SPI Flash (GD25QXX???)
  - SDIO??? (???SD??)
  - USART??????
  - ADC????????
  - DAC????????

## ???????

??????????????????????????:

1. **?????? (Driver)**
   - GD32F4XX????????
   - CMSIS?????

2. **????? (Components)**
   - `bsp`: ???????????????????????????
   - `ebtn`: ????????????????????????????
   - `gd25qxx`: SPI Flash?????????????????DMA??????
   - `oled`: OLED?????????????????????????????
   - `sdio`: SD?????????

3. **????? (APP)**
   - `btn_app`: ??????????
   - `led_app`: LED???????
   - `oled_app`: OLED??????
   - `usart_app`: ??????????
   - `scheduler`: ?????????????

## ????????

1. **???????????**
   - GPIO???????????????
   - ????DMA?????SPI???
   - I2C?????????????????
   - SDIO??????
   - 12??DAC??ADC???

2. **????????????**
   - ??????????????
   - ???????????????
   - ????????????????

3. **?????????**
   - LED??????????
   - ????????????
   - OLED?????
   - ??????????
   - ADC??????????????

## ??????

### ???????????
- MDK-ARM 5.25??????
- IAR EWARM 8.20??????
- GCC ARM?????? (???)

### ????????? (MDK-ARM)
1. ??`MDK/Project.uvprojx`???????
2. ??????: Project -> Rebuild all target files
3. ???????: Debug -> Start/Stop Debug Session
4. ????????: Debug -> Run (F5)

### ????????? (IAR EWARM)
1. ??EWARM???????
2. ???????????: Project -> Rebuild all
3. ?????????: Project -> Debug
4. ????????: Debug -> Go (F5)

## ????????

???????????????????????????????????????????????????????:

1. **???????????????**
   - ??`Components`???????????????????
   - ???????????????????

2. **??????????**
   - ??`APP`???????????????
   - ??`scheduler.c`????????????

3. **?????????**
   - ???????????`USER/src/main.c`
   - ????????????????????????????????????

## ???????

1. ??????????????`Docs`??????????????????????????????????
2. ???DMA??????????????????????????????DMA????????????????
3. ????????????????????????????????????????DMA??
4. OLED??SPI Flash????????????????????????????????????????????????

## ??????????

### SPI Flash DMA????
???????????SPI Flash??DMA????????????????????????????????????????????????????

### OLED I2C??????????
???I2C?????????????????????????????????????????????OLED???????????

### DAC???????
???DAC??????????????????????????????????????????

### ADC??????????
????????????????ADC???????????
- **????1 (USER_BUTTON_0)**: ???ADC?????????100ms??????ADC??????????SD?????
- **????2 (USER_BUTTON_1)**: ??ADC?????????????????????????????????
- **??????**: `ADC????-????\r\n` (????: `2048-12345\r\n`)
- **???????**: ????????1????????? (????: `ADC_12345.txt`)
- **???????**: SD?????? (`0:/ADC_xxxxx.txt`)

## ?????????

????????McuSTUDIO??????????????????????????????????????????????????GD32????????????????(GigaDevice)??????

## ??????

?????????????????????????

---

*????????2025??6??5??*

## ??????????

### ADC?????????????????????
???"??????????????"????????????????????

1. **?????????????**??
   - ?????????????????????????
   - ?????????????????????????????

2. **?????????**??
   - ??????????????????
   - ???????????????????
   - ???????????????

3. **?????????**??
   - ??????????????????????
   - ?????????????????
   - ????????????????

4. **???????**??
   - ??????????????????
   - ??????????????????
   - ?????????????????
### ?????????? (Error 6 ???)

#### ???????????
- **????1 (USER_BUTTON_0)**: ???ADC??????
- **????2 (USER_BUTTON_1)**: ??ADC?????????????????
- **????3 (USER_BUTTON_2)**: ????????????????????

#### ??????????? (???Error 6: FR_DENIED)
1. **???????????**: ?????????????????????
2. **???????????**: ???????????????????????????
3. **?????????**: ?????????????????????
4. **?????????????**: ?????????????ü????? `ADC.txt`
5. **??????????**: ??????д?????????????????????

#### ??????????
```
File system status: OK
Free clusters: 15234
Cluster size: 1024 bytes
Free space: 15234 KB
ADC recording started: 0:/ADC_12345.txt
```

## FATFS长文件名支持 (_USE_LFN=3)

### 新增API接口实现

当设置`_USE_LFN=3`（基于堆的长文件名支持）时，需要实现以下API接口：

#### 1. Unicode处理函数
- **`ff_convert()`**: Unicode字符转换函数
  - 支持Unicode到OEM代码页的双向转换
  - 简化实现，支持基本ASCII和常用拉丁字符
  - 扩展字符自动转换为ASCII兼容字符

- **`ff_wtoupper()`**: Unicode字符转大写函数
  - 支持ASCII字符a-z转A-Z
  - 支持常用拉丁字符的大小写转换
  - 未知字符保持原样

#### 2. 内存管理函数
- **`ff_memalloc()`**: 动态内存分配
  - 基于标准库malloc()实现
  - 用于LFN工作缓冲区分配

- **`ff_memfree()`**: 动态内存释放
  - 基于标准库free()实现
  - 释放LFN工作缓冲区

#### 3. 时间戳函数
- **`get_fattime()`**: 获取FAT文件系统时间戳
  - 基于系统毫秒计数器生成时间戳
  - 返回FAT32标准时间格式
  - 支持文件创建和修改时间记录

### 实现文件
- `Components/fatfs/fatfs_unicode.c` - Unicode处理函数实现
- `Components/fatfs/fatfs_unicode.h` - 函数声明头文件
- `Components/fatfs/diskio.c` - 时间戳函数实现

### 配置说明
```c
#define _USE_LFN    3       // 启用基于堆的长文件名支持
#define _MAX_LFN    255     // 最大长文件名长度
#define _CODE_PAGE  932     // 日文Shift-JIS代码页
```
