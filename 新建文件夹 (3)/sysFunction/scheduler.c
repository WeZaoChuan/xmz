#include "scheduler.h"


// ??????????????????????
uint8_t task_num;

typedef struct {
    void (*task_func)(void);
    uint32_t rate_ms;
    uint32_t last_run;
} task_t;

// ?????????????????????????????????????????????????????????
static task_t scheduler_task[] =
{

     {led_task,  1,  0}
    ,{adc_task,  1,  0}  // ????1ms???
    ,{btn_task,  5,  0}
    ,{uart_task, 5,  0}
		,{oled_task, 1,  0}    // 修改为1ms间隔，高频刷新
};

/**
 * @brief ???????????????
 * ????????????????????????????????? task_num ??
 */
void scheduler_init(void)
{
    // ????????????????????????????????? task_num ??
    task_num = sizeof(scheduler_task) / sizeof(task_t);
}

/**
 * @brief ??????????????
 * ?????????????????????????????????????????????????????????????????????????????????????
 */
void scheduler_run(void)
{
    // ????????????????????????
    for (uint8_t i = 0; i < task_num; i++)
    {
        // ?????????????????
        uint32_t now_time = HAL_GetTick();

        // ???n???????????????????
        if (now_time >= scheduler_task[i].rate_ms + scheduler_task[i].last_run)
        {
            // ??????????????????????????
            scheduler_task[i].last_run = now_time;

            // ?????????
            scheduler_task[i].task_func();
        }
    }
}


